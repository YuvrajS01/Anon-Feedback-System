{% extends "base.html" %}

{% block title %}Admin Dashboard - Student Feedback{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="admin-header">
        <h2>ðŸ“Š Admin Dashboard</h2>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary btn-small">Logout</a>
    </div>

    <!-- Token & Session Statistics -->
    <div class="card">
        <h3>Statistics</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-value">{{ token_stats.total }}</span>
                <span class="stat-label">Total Tokens</span>
            </div>
            <div class="stat-item stat-success">
                <span class="stat-value">{{ token_stats.used }}</span>
                <span class="stat-label">Used</span>
            </div>
            <div class="stat-item stat-pending">
                <span class="stat-value">{{ token_stats.unused }}</span>
                <span class="stat-label">Unused</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ session_stats.complete_sessions }}</span>
                <span class="stat-label">Complete</span>
            </div>
        </div>

        {% if token_stats.total > 0 %}
        <div class="progress-bar" style="margin-top: 1rem;">
            <div class="progress-fill" style="width: {{ (token_stats.used / token_stats.total * 100)|round }}%"></div>
        </div>
        <p style="text-align: center; font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
            {{ (token_stats.used / token_stats.total * 100)|round }}% response rate
        </p>
        {% endif %}
    </div>

    <!-- Current Teacher-Subject Combos -->
    <div class="card">
        <h3>Active Teacher-Subject Combos</h3>
        {% if combos %}
        <div class="combos-list">
            {% for combo in combos %}
            <div class="combo-item">
                <div class="combo-info">
                    <span class="combo-number">{{ loop.index }}</span>
                    <div>
                        <strong>{{ combo.teacher }}</strong>
                        <span style="color: var(--text-muted);"> â€” {{ combo.subject }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">No combos configured. Use the Control Panel to add teacher-subject pairs.</p>
        {% endif %}
    </div>

    <!-- Overall Question Averages -->
    {% if question_averages and question_averages.q1 is not none %}
    <div class="card">
        <h3>Overall Question Averages</h3>
        <div class="questions-avg-list">
            {% for i in range(10) %}
            <div class="question-avg-item">
                <span class="question-text">{{ questions[i] }}</span>
                <div class="avg-bar-container">
                    <div class="avg-bar" style="width: {{ (question_averages['q' ~ (i+1)] or 0) * 10 }}%"></div>
                </div>
                <span class="avg-value">{{ question_averages['q' ~ (i+1)] or 'N/A' }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Teacher-Subject Summary -->
    <div class="card">
        <h3>Teacher-Subject Summary</h3>

        {% if teacher_summary %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Teacher</th>
                        <th>Subject</th>
                        <th>Responses</th>
                        <th>Avg Rating</th>
                        <th>Export</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in teacher_summary %}
                    <tr>
                        <td>{{ item.teacher }}</td>
                        <td>{{ item.subject }}</td>
                        <td>{{ item.feedback_count }}</td>
                        <td>
                            <span class="rating-badge 
                                {% if item.overall_avg >= 7 %}rating-high
                                {% elif item.overall_avg >= 4 %}rating-medium
                                {% else %}rating-low{% endif %}">
                                {{ item.overall_avg }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('export_teacher', teacher_name=item.teacher) }}"
                                class="btn btn-small btn-export">
                                ðŸ“¥ Excel
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">No feedback data available yet.</p>
        {% endif %}
    </div>

    <!-- Export Options -->
    <div class="card">
        <h3>Export Reports</h3>
        <div class="export-grid">
            <div class="export-section">
                <h4>All Feedback</h4>
                <a href="{{ url_for('export_all') }}" class="btn btn-primary">
                    ðŸ“¥ Download All Feedback
                </a>
            </div>

            {% if teachers %}
            <div class="export-section">
                <h4>By Teacher</h4>
                <div class="export-buttons">
                    {% for teacher in teachers %}
                    <a href="{{ url_for('export_teacher', teacher_name=teacher) }}" class="btn btn-secondary btn-small">
                        {{ teacher }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if subjects %}
            <div class="export-section">
                <h4>By Subject</h4>
                <div class="export-buttons">
                    {% for subject in subjects %}
                    <a href="{{ url_for('export_subject', subject_name=subject) }}" class="btn btn-secondary btn-small">
                        {{ subject }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}